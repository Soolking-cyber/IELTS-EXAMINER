<!DOCTYPE html>
<html>
<head>
    <title>TRTC SDK Loading Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>üß™ TRTC SDK Loading Test</h1>
    <div id="results"></div>

    <script>
        const results = document.getElementById('results');
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = message;
            results.appendChild(div);
        }

        async function loadScript(url) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = url;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        async function testTRTCSDK() {
            log('<h2>Testing TRTC SDK Loading...</h2>');
            
            const cdnUrls = [
                'https://web.sdk.qcloud.com/trtc/webrtc/v5/dist/trtc.js',
                'https://cdn.jsdelivr.net/npm/trtc-js-sdk@4.15.0/dist/trtc.js',
                'https://unpkg.com/trtc-js-sdk@4.15.0/dist/trtc.js'
            ];

            for (const url of cdnUrls) {
                try {
                    log(`üì• Trying to load: ${url}`, 'info');
                    await loadScript(url);
                    
                    if (window.TRTC) {
                        log(`‚úÖ Success! TRTC loaded from: ${url}`, 'success');
                        log(`üîß TRTC methods available: ${Object.keys(window.TRTC).join(', ')}`, 'info');
                        
                        // Test browser compatibility
                        if (typeof window.TRTC.isSupported === 'function') {
                            const isSupported = window.TRTC.isSupported();
                            log(`üåê Browser compatibility: ${isSupported ? 'Supported' : 'Not supported'}`, 
                                isSupported ? 'success' : 'error');
                        }
                        
                        // Test create method
                        if (window.TRTC.create) {
                            try {
                                const client = window.TRTC.create();
                                log(`‚úÖ TRTC.create() works! Client created.`, 'success');
                                log(`üéØ Ready for TRTC integration!`, 'success');
                            } catch (e) {
                                log(`‚ùå TRTC.create() failed: ${e.message}`, 'error');
                            }
                        } else {
                            log(`‚ùå TRTC.create method not available`, 'error');
                        }
                        
                        return; // Success, stop trying other URLs
                    } else {
                        log(`‚ùå TRTC not available after loading ${url}`, 'error');
                    }
                } catch (error) {
                    log(`‚ùå Failed to load ${url}: ${error.message}`, 'error');
                }
            }
            
            log(`‚ùå All CDN sources failed to load TRTC SDK`, 'error');
        }

        // Test UserSig API
        async function testUserSigAPI() {
            log('<h2>Testing UserSig API...</h2>');
            
            const userId = 'test-user-' + Date.now();
            
            try {
                log(`üì§ Testing POST /api/trtc/usersig with userId: ${userId}`, 'info');
                
                const response = await fetch('/api/trtc/usersig', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log(`‚úÖ UserSig API Success!`, 'success');
                    log(`<pre>${JSON.stringify(result, null, 2)}</pre>`, 'info');
                    
                    // Validate UserSig
                    if (result.userSig && result.userSig.length > 100) {
                        log(`‚úÖ UserSig format looks valid (length: ${result.userSig.length})`, 'success');
                    } else {
                        log(`‚ùå UserSig format looks invalid`, 'error');
                    }
                } else {
                    const error = await response.text();
                    log(`‚ùå UserSig API Failed: ${error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå UserSig API Error: ${error.message}`, 'error');
            }
        }

        // Run tests
        testTRTCSDK().then(() => {
            return testUserSigAPI();
        }).catch(console.error);
    </script>
</body>
</html>